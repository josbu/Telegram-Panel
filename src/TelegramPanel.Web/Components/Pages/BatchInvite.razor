@page "/batch/invite"
@inject IChannelService ChannelService
@inject AccountManagementService AccountManagement
@inject ChannelManagementService ChannelManagement
@inject BatchTaskManagementService TaskManagement
@inject ISnackbar Snackbar
@using TelegramPanel.Data.Entities

<PageTitle>批量邀请 - Telegram Panel</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">批量邀请用户</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">配置邀请</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudSelect @bind-Value="selectedAccountId" Label="执行账号" Variant="Variant.Outlined" Required="true">
                    <MudSelectItem Value="0">-- 请选择账号 --</MudSelectItem>
                    @foreach (var account in accounts)
                    {
                        <MudSelectItem Value="@account.Id">@account.Phone (@account.Username)</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="selectedChannelId" Label="目标频道" Variant="Variant.Outlined" Required="true" Class="mt-4">
                    <MudSelectItem Value="0">-- 请选择频道 --</MudSelectItem>
                    @foreach (var channel in channels)
                    {
                        <MudSelectItem Value="@channel.Id">@channel.Title (@channel.Username)</MudSelectItem>
                    }
                </MudSelect>

                <MudTextField @bind-Value="usernames" Label="用户名列表" Variant="Variant.Outlined" Lines="10" Class="mt-4"
                              HelperText="每行一个用户名" />

                <MudNumericField @bind-Value="delayMs" Label="邀请间隔 (毫秒)" Variant="Variant.Outlined" Min="1000" Max="10000" Class="mt-4"
                                 HelperText="建议设置2000-5000ms，避免触发风控" />
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearForm">清空</MudButton>
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           Disabled="@(selectedAccountId == 0 || selectedChannelId == 0 || string.IsNullOrEmpty(usernames) || inviting)"
                           OnClick="StartInvite">
                    @if (inviting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>邀请中...</span>
                    }
                    else
                    {
                        <span>开始邀请</span>
                    }
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">邀请结果</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudList T="string" Dense="true">
                    @foreach (var result in inviteResults)
                    {
                        <MudListItem T="string" Icon="@(result.Success ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)"
                                     IconColor="@(result.Success ? Color.Success : Color.Error)">
                            <div>
                                <MudText Typo="Typo.body2">@("@" + result.Username)</MudText>
                                @if (!result.Success && result.Error != null)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Error">@result.Error</MudText>
                                }
                            </div>
                        </MudListItem>
                    }
                </MudList>
                @if (inviteResults.Any())
                {
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.body2">
                        成功：@inviteResults.Count(r => r.Success) / 总计：@inviteResults.Count
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private List<Account> accounts = new();
    private List<Channel> channels = new();
    private int selectedAccountId = 0;
    private int selectedChannelId = 0;
    private string usernames = "";
    private int delayMs = 2000;
    private bool inviting = false;

    private List<InviteResult> inviteResults = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
        await LoadChannels();
    }

    private async Task LoadAccounts()
    {
        try
        {
            var accountList = await AccountManagement.GetActiveAccountsAsync();
            accounts = accountList.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载账号列表失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task LoadChannels()
    {
        try
        {
            var channelList = await ChannelManagement.GetAllChannelsAsync();
            channels = channelList.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载频道列表失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task StartInvite()
    {
        inviting = true;
        inviteResults.Clear();

        try
        {
            // 解析用户名列表
            var usernameList = usernames.Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(u => u.Trim().TrimStart('@'))
                .Where(u => !string.IsNullOrEmpty(u))
                .ToList();

            if (usernameList.Count == 0)
            {
                Snackbar.Add("请输入至少一个用户名", Severity.Warning);
                return;
            }

            // 获取选中的频道
            var channel = channels.FirstOrDefault(c => c.Id == selectedChannelId);
            if (channel == null)
            {
                Snackbar.Add("未找到选中的频道", Severity.Error);
                return;
            }

            // 创建批量任务记录
            var task = new BatchTask
            {
                TaskType = "invite",
                Total = usernameList.Count,
                Completed = 0,
                Failed = 0,
                Config = System.Text.Json.JsonSerializer.Serialize(new
                {
                    ChannelId = channel.TelegramId,
                    ChannelTitle = channel.Title,
                    DelayMs = delayMs
                })
            };
            var createdTask = await TaskManagement.CreateTaskAsync(task);
            await TaskManagement.StartTaskAsync(createdTask.Id);

            // 执行批量邀请
            var results = await ChannelService.BatchInviteUsersAsync(selectedAccountId, channel.TelegramId, usernameList, delayMs);
            inviteResults.AddRange(results);

            // 更新任务状态
            var successCount = results.Count(r => r.Success);
            var failedCount = results.Count(r => !r.Success);
            await TaskManagement.UpdateTaskProgressAsync(createdTask.Id, successCount, failedCount);
            await TaskManagement.CompleteTaskAsync(createdTask.Id, true);

            Snackbar.Add($"邀请完成：{successCount}/{results.Count} 成功", successCount == results.Count ? Severity.Success : Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"邀请失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            inviting = false;
        }
    }

    private void ClearForm()
    {
        usernames = "";
        inviteResults.Clear();
    }
}
